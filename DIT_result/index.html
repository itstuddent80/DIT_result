<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IT Department Grade Sheet</title>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="header">
  <img src="download.jpeg" alt="MMP Logo">
  <div class="brand-text">
    <h1 class="title"></i> Manmohan Memorial Polytechnic</h1>
    <h2>Department of Information Technology</h2>
    <h3>1st Internal Assessment Results</h3>
  </div>
</div>

<div class="form-container">
  <input type="text" id="roll" placeholder="Enter Roll No">
  <select id="sem">
    <option value="">Select Semester</option>
    <option value="1">Semester 1</option>
    <option value="2">Semester 2</option>
    <option value="3">Semester 3</option>
    <option value="4">Semester 4</option>
    <option value="5">Semester 5</option>
    <option value="6">Semester 6</option>
  </select>
  <input type="text" id="dob" placeholder="Enter DOB (YYYY-MM-DD)">
  <button onclick="viewResult()"><i class="fas fa-eye"></i> View Result</button>
</div>

<div id="output"></div>

<script>
// Inlined app.js — combined JS
const API_URL = "https://script.google.com/macros/s/AKfycbyvu_zDHgUVGe3v0xVZwFU7bbO7G3lMqBVOCG0N0dqeyZNsdKcTmkt4wdp5HLOx7tSLEQ/exec";

function setOutput(html) {
  const out = document.getElementById('output');
  if (out) out.innerHTML = html; else console.warn('Output container not found');
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]);
}

function debugLog(msg) {
  const dbg = document.getElementById('debug');
  if (dbg) dbg.textContent += msg + "\n";
  console.debug(msg);
}

// Global error handlers to show JS/runtime issues on the page for easier diagnosis
window.addEventListener('error', e => {
  const msg = `JS Error: ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`;
  debugLog(msg);
  setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> ${escapeHtml(msg)}</p>`);
  console.error(e.error || e.message, e);
});

window.addEventListener('unhandledrejection', e => {
  const reason = (e.reason && (e.reason.message || e.reason)) || String(e.reason);
  const msg = `Unhandled Promise Rejection: ${reason}`;
  debugLog(msg);
  setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> ${escapeHtml(msg)}</p>`);
  console.error('Unhandled rejection', e);
});

function parseDOB(input) {
  if (!input) return null;
  input = input.trim();

  // Return object: { isBS: boolean, date: Date|null, normalized: 'YYYY-MM-DD' }

  // Try ISO formats first (YYYY-MM-DD or YYYY/MM/DD)
  let m = input.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})$/);
  if (m) {
    const y = Number(m[1]), mon = Number(m[2]), d = Number(m[3]);
    const norm = `${y}-${('0'+mon).slice(-2)}-${('0'+d).slice(-2)}`;

    // Detect BS by heuristic: if year > current AD year, treat as BS
    const currentYear = new Date().getFullYear();
    if (y > currentYear) {
      debugLog(`parseDOB: detected possible BS year ${y}; treating as BS with normalized ${norm}`);
      return { isBS: true, date: null, normalized: norm };
    }

    const date = new Date(y, mon-1, d);
    if (date.getFullYear() === y && date.getMonth() === mon-1 && date.getDate() === d) {
      if (date > new Date()) return null;
      if (y < 1900) return null;
      debugLog(`parseDOB: matched YYYY-MM-DD AD -> ${norm}`);
      return { isBS: false, date, normalized: norm };
    }
  }

  // Try common human formats: DD/MM/YYYY or MM/DD/YYYY or DD-MM-YYYY or MM-DD-YYYY
  m = input.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
  if (m) {
    const a = Number(m[1]), b = Number(m[2]), y = Number(m[3]);
    let d, mon;
    if (a > 12 && b <= 12) {
      d = a; mon = b; // DD/MM/YYYY
    } else if (b > 12 && a <= 12) {
      mon = a; d = b; // MM/DD/YYYY
    } else {
      // Ambiguous (both <=12) — prefer DD/MM/YYYY
      d = a; mon = b;
    }

    const norm = `${y}-${('0'+mon).slice(-2)}-${('0'+d).slice(-2)}`;
    // Heuristic: if year > current year => BS
    const currentYear = new Date().getFullYear();
    if (y > currentYear) {
      debugLog(`parseDOB: detected possible BS year ${y} from human format; treating as BS -> ${norm}`);
      return { isBS: true, date: null, normalized: norm };
    }

    const date = new Date(y, mon-1, d);
    if (date.getFullYear() === y && date.getMonth() === mon-1 && date.getDate() === d) {
      if (date > new Date()) return null;
      if (y < 1900) return null;
      debugLog(`parseDOB: matched human format -> interpreted as ${norm}`);
      return { isBS: false, date, normalized: norm };
    }
  }

  // No match
  return null;
}

function formatDisplayDate(date) {
  if (!date) return '-';
  return `${date.getFullYear()}-${('0'+(date.getMonth()+1)).slice(-2)}-${('0'+date.getDate()).slice(-2)}`;
}

async function viewResult() {
  // Quick check: if the page is opened via file:// some browsers block fetch/CORS
  if (location.protocol === 'file:') {
    setOutput("<p class='error'><i class='fas fa-exclamation-circle'></i> Page opened via file:// — open over HTTP (e.g. run 'python -m http.server' or use VSCode Live Server) to allow network requests.</p>");
    console.warn('Page opened via file:// — fetching may be blocked by browser');
    return;
  }

  const roll = document.getElementById("roll").value.trim();
  const sem = document.getElementById("sem").value;
  const dobInput = document.getElementById("dob").value.trim();

  if (!roll || !sem || !dobInput) {
    setOutput("<p class='error'><i class='fas fa-exclamation-circle'></i> Please enter Roll No, Semester, and DOB</p>");
    return;
  }

  const parsed = parseDOB(dobInput);
  debugLog(`parseDOB result for input "${dobInput}": ${parsed ? (parsed.isBS ? parsed.normalized + ' (BS)' : formatDisplayDate(parsed.date)) : 'invalid'}`);
  if (!parsed) {
    setOutput("<p class='error'><i class='fas fa-exclamation-circle'></i> Invalid DOB. Use YYYY-MM-DD.</p>");
    debugLog(`parseDOB failed for input "${dobInput}"`);
    return;
  }

  // If parsed indicates BS, send the normalized BS date string directly; otherwise send normalized AD YYYY-MM-DD
  let dobForServer;
  if (parsed.isBS) {
    dobForServer = parsed.normalized; // send BS date as-is to the sheet
    debugLog(`Using BS DOB for server: ${dobForServer}`);
  } else {
    dobForServer = parsed.date.toISOString().slice(0,10);
  }

  const requestUrl = `${API_URL}?roll=${encodeURIComponent(roll)}&sem=${encodeURIComponent(sem)}&dob=${encodeURIComponent(dobForServer)}`;

  // Show only a friendly loading message while we fetch; keep debug logs console-only
  setOutput('<p class="muted">Loading results…</p>');
  debugLog(`requestUrl=${requestUrl}`);

  try {
    const res = await fetch(requestUrl, { mode: 'cors' });

    const respText = await res.text();
    debugLog(`HTTP ${res.status} ${res.statusText} — body length ${respText.length}`);

    if (!res.ok) {
      setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> Server returned ${res.status} ${res.statusText}<br><pre>${escapeHtml(respText)}</pre></p>`);
      console.error('Non-OK response', res.status, res.statusText, respText);
      return;
    }

    let data;
    try {
      data = JSON.parse(respText);
    } catch (parseErr) {
      setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> Server returned non-JSON response:<br><pre>${escapeHtml(respText)}</pre></p>`);
      console.error('JSON parse error', parseErr, respText);
      debugLog(`JSON parse error: ${parseErr.message}`);
      return;
    }

    if (!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
      setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> No data returned for the provided details.</p>`);
      debugLog(`Empty data response: ${respText}`);
      return;
    }

    if (data.error) {
      setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> ${data.error}</p>`);
      return;
    }

    // If server returned OK but no subject rows, show message
    if (!Array.isArray(data.Subjects) || data.Subjects.length === 0) {
      setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> No results found for these details.</p>`);
      debugLog(`No Subjects in response: ${JSON.stringify(data)}`);
      return;
    }

    // Prefer showing raw YYYY-MM-DD from the sheet; otherwise attempt to parse and normalize
    let dobDisplay = '-';
    if (data.DOB) {
      if (/^\d{4}-\d{2}-\d{2}$/.test(data.DOB)) dobDisplay = data.DOB;
      else {
        const d = new Date(data.DOB);
        dobDisplay = formatDisplayDate(d);
      }
    }

    // Strict verification: normalize values and compare (but don't reveal DB values on mismatch)
    const enteredNormalized = parsed.isBS ? parsed.normalized : parsed.date.toISOString().slice(0,10);

    // Helpers for normalization and comparison
    function normalizeDobString(s) {
      if (!s) return null;
      s = String(s).trim().replace(/\//g,'-');
      // YYYY-M-D or YYYY-MM-DD
      let m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      if (m) {
        const y = Number(m[1]), mon = Number(m[2]), d = Number(m[3]);
        const date = new Date(y, mon-1, d);
        if (date.getFullYear()===y && date.getMonth()===mon-1 && date.getDate()===d) return `${y}-${('0'+mon).slice(-2)}-${('0'+d).slice(-2)}`;
      }
      // D-M-YYYY or DD-MM-YYYY
      m = s.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
      if (m) {
        const a = Number(m[1]), b = Number(m[2]), y = Number(m[3]);
        const d = a, mon = b; // interpret as DD-MM-YYYY
        const date = new Date(y, mon-1, d);
        if (date.getFullYear()===y && date.getMonth()===mon-1 && date.getDate()===d) return `${y}-${('0'+mon).slice(-2)}-${('0'+d).slice(-2)}`;
      }
      return null;
    }

    function compareRolls(e, s) {
      const a = String(e || '').trim();
      const b = String(s || '').trim();
      if (/^\d+$/.test(a) && /^\d+$/.test(b)) return Number(a) === Number(b);
      return a.toLowerCase() === b.toLowerCase();
    }

    function compareSem(e, s) {
      const a = Number(String(e || '').trim());
      const b = Number(String(s || '').trim());
      if (!isNaN(a) && !isNaN(b)) return a === b;
      return String(e || '').trim() === String(s || '').trim();
    }

    // Build normalized DOB candidates from server value (handle YYYY-MM-DD, ISO datetime, and +/-1 day offsets)
    let serverDobCandidates = [];
    if (data.DOB) {
      const s = String(data.DOB).trim();
      const n1 = normalizeDobString(s);
      if (n1) serverDobCandidates.push(n1);

      const dt = new Date(s);
      if (!isNaN(dt)) {
        // local date (formatDisplayDate uses local date)
        serverDobCandidates.push(formatDisplayDate(dt));
        // UTC date
        const utc = `${dt.getUTCFullYear()}-${('0'+(dt.getUTCMonth()+1)).slice(-2)}-${('0'+dt.getUTCDate()).slice(-2)}`;
        serverDobCandidates.push(utc);
        // +/- 1 day (UTC) to tolerate timezone shifts
        const plus1 = new Date(dt);
        plus1.setUTCDate(plus1.getUTCDate()+1);
        serverDobCandidates.push(`${plus1.getUTCFullYear()}-${('0'+(plus1.getUTCMonth()+1)).slice(-2)}-${('0'+plus1.getUTCDate()).slice(-2)}`);
        const minus1 = new Date(dt);
        minus1.setUTCDate(minus1.getUTCDate()-1);
        serverDobCandidates.push(`${minus1.getUTCFullYear()}-${('0'+(minus1.getUTCMonth()+1)).slice(-2)}-${('0'+minus1.getUTCDate()).slice(-2)}`);
      }

      // Deduplicate
      serverDobCandidates = Array.from(new Set(serverDobCandidates));
    }

    const rollMatch = compareRolls(roll, data['Roll No']);
    const semMatch = compareSem(sem, data.Semester);

    let dobMatch = false;
    if (parsed.isBS) {
      // accept exact BS string or any candidate equal to normalized BS
      dobMatch = String(data.DOB).trim() === String(parsed.normalized).trim() || serverDobCandidates.includes(parsed.normalized);
    } else {
      dobMatch = serverDobCandidates.includes(enteredNormalized);
    }

    if (!(rollMatch && semMatch && dobMatch)) {
      setOutput('<p class="error"><i class="fas fa-exclamation-circle"></i> Record not found. Please verify your Roll No, Semester and DOB.</p>');
      console.debug(`Record mismatch (hidden): rollMatch=${rollMatch} semMatch=${semMatch} dobMatch=${dobMatch} entered=${enteredNormalized} serverCandidates=${serverDobCandidates.join(',')}`);
      return;
    }

    const subjects = Array.isArray(data.Subjects) ? data.Subjects : [];
    let totalMarks = 0;
    let totalAttendance = 0;
    let overallPass = true;

    const genDate = new Date().toLocaleDateString();

    let html = `
    <div class="result-card card-shadow">
      <div class="result-header">
        <div class="college-left">
          <img src="download.jpeg" alt="Logo">
          <div>
            <div class="college-name">Manmohan Memorial Polytechnic</div>
            <div class="dept">Department of Information Technology</div>
          </div>
        </div>
        <div class="result-meta">
          <div class="assessment-title">1st Internal Assessment</div>
          <div class="small muted">Generated: ${genDate}</div>
        </div>
      </div>

      <div class="student-info">
        <div><b>Student Name:</b> ${data.Name || '-'}</div>
        <div><b>Roll No:</b> ${data['Roll No'] || '-'}</div>
        <div><b>Semester:</b> ${data.Semester || '-'}</div>
        <div><b>DOB:</b> ${dobDisplay}</div>
      </div>

      <div class="table-wrap">
        <table class="result-table">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Marks</th>
              <th class="center">Attendance</th>
              <th class="center">Remarks</th>
            </tr>
          </thead>
          <tbody>`;

    subjects.forEach(sub => {
      // Support explicit "abs" or "absent" markers in the marks column to indicate the student missed that subject
      const rawMark = (sub.mark === undefined || sub.mark === null) ? '' : String(sub.mark).trim();
      const isAbsent = /^(abs|absent)$/i.test(rawMark);
      const mark = isAbsent ? 'Absent' : (Number(sub.mark) || 0);
      const att = Number(sub.attendance) || 0;
      // Absent entries are treated as failing for the overall result
      const isPass = !isAbsent && Number(mark) >= 8;
      if (!isPass) overallPass = false; // absent or below pass threshold -> overall fail
      const statusHtml = isAbsent
        ? `<span class="status absent"><i class="fas fa-user-times"></i> Absent</span>`
        : (isPass
            ? `<span class="status pass"><i class="fas fa-check-circle"></i> Pass</span>`
            : `<span class="status fail"><i class="fas fa-times-circle"></i> Fail</span>`);
      const rowClass = isAbsent ? 'absent fail' : (isPass ? 'pass' : 'fail');
      const subjectCellClass = `subject ${isAbsent ? 'absent-text' : ''}`;
      html += `<tr class="${rowClass}"><td class="${subjectCellClass}">${sub.name}</td><td class="center">${mark}</td><td class="center">${att}%</td><td class="center">${statusHtml}</td></tr>`;
      if (!isAbsent) totalMarks += Number(mark);
      totalAttendance += att;
    });

    const avgAttendance = subjects.length ? (totalAttendance / subjects.length).toFixed(2) : '0.00';
    const overallStatus = subjects.length ? (overallPass ? 'Pass' : 'Fail') : '-';
    const overallHtml = overallStatus === '-' ? '-' : (overallStatus === 'Pass'
      ? `<span class="status pass"><i class="fas fa-check-circle"></i> Pass</span>`
      : `<span class="status fail"><i class="fas fa-times-circle"></i> Fail</span>`);

    html += `</tbody>
          <tfoot>
            <tr class="summary-row">
              <th>Total</th>
              <th>${totalMarks}</th>
              <th class="center"></th>
              <th class="center">${overallHtml}</th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="actions">
        <button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
      </div>

      <div class="signatures">
        <div class="signature">
          <div class="sig-line"></div>
          <div class="sig-title">Prepared By:</div>
        </div>
        <div class="signature">
          <div class="sig-line"></div>
          <div class="sig-title">Head of Department</div>
        </div>
      </div>
    </div>`;

    setOutput(html);

  } catch (err) {
    console.error('Fetch error:', err);
    setOutput(`<p class='error'><i class='fas fa-exclamation-circle'></i> Fetch error: ${err.message}</p>`);
  }
}

// Attach event handlers and add small UX improvements
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('button[onclick="viewResult()"]');
  if (btn) btn.addEventListener('click', viewResult);

  // Allow Enter to submit on inputs
  ['roll','dob'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('keypress', (e) => { if (e.key === 'Enter') viewResult(); });
  });
});
</script>

</body>
</html>
